# =================================
# PostgreSQL Production Configuration
# Optimized for production workloads
# =================================

# =================================
# Connection Settings
# =================================
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# =================================
# Memory Settings
# =================================
shared_buffers = 256MB              # 25% of RAM for dedicated DB server
effective_cache_size = 1GB          # 75% of available RAM
work_mem = 4MB                      # Per-operation memory
maintenance_work_mem = 64MB         # Maintenance operations

# =================================
# Checkpoint Settings
# =================================
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min
checkpoint_warning = 30s

# =================================
# WAL (Write-Ahead Logging) Settings
# =================================
wal_buffers = 16MB
wal_level = replica
max_wal_size = 1GB
min_wal_size = 80MB
wal_compression = on
wal_keep_segments = 32

# =================================
# Query Tuning
# =================================
random_page_cost = 1.1             # For SSD storage
effective_io_concurrency = 200     # For SSD storage
default_statistics_target = 100

# =================================
# Logging Settings
# =================================
logging_collector = on
log_directory = '/var/lib/postgresql/data/logs'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_statement = 'none'             # none, ddl, mod, all
log_min_duration_statement = 1000  # Log slow queries (1 second)
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

# =================================
# Security Settings
# =================================
password_encryption = scram-sha-256
ssl = off                          # Handled by reverse proxy
row_security = on

# =================================
# Autovacuum Settings
# =================================
autovacuum = on
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_max_workers = 3

# =================================
# Background Writer Settings
# =================================
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 512kB

# =================================
# Archive Settings (for Point-in-Time Recovery)
# =================================
archive_mode = on
archive_command = 'test ! -f /backups/archive/%f && cp %p /backups/archive/%f'
archive_timeout = 1800

# =================================
# Replication Settings
# =================================
max_wal_senders = 10
wal_sender_timeout = 60s
max_replication_slots = 10

# =================================
# Extension Settings
# =================================
shared_preload_libraries = 'pg_stat_statements'

# =================================
# Time Zone
# =================================
timezone = 'UTC'
log_timezone = 'UTC'

# =================================
# Locale Settings
# =================================
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# =================================
# Connection Pooling Settings
# =================================
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# =================================
# Lock Settings
# =================================
deadlock_timeout = 1s
max_locks_per_transaction = 256
max_pred_locks_per_transaction = 64

# =================================
# Performance Settings
# =================================
synchronous_commit = on            # Ensure data safety
fsync = on                        # Ensure data safety
full_page_writes = on             # Ensure data safety
wal_sync_method = fsync
commit_delay = 0
commit_siblings = 5