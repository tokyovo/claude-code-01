# =================================
# Redis Production Configuration
# Optimized for production caching and session management
# =================================

# =================================
# Basic Configuration
# =================================
bind 0.0.0.0
port 6379
timeout 300
tcp-keepalive 60

# =================================
# Security
# =================================
# Password is set via command line argument
# requirepass is handled by docker-compose environment

# =================================
# General Settings
# =================================
daemonize no
pidfile /var/run/redis_6379.pid
loglevel notice
logfile ""
databases 16

# =================================
# Memory Management
# =================================
maxmemory 512mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# =================================
# Persistence Settings
# =================================
# Save the DB to disk
save 900 1      # At least 1 change in 900 seconds (15 minutes)
save 300 10     # At least 10 changes in 300 seconds (5 minutes)
save 60 10000   # At least 10000 changes in 60 seconds

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# =================================
# Append Only File (AOF) Settings
# =================================
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# =================================
# Performance Settings
# =================================
# Disable transparent huge pages (THP) warning
# This should be done at the OS level, but we acknowledge it here
# echo never > /sys/kernel/mm/transparent_hugepage/enabled

# =================================
# Client Connection Settings
# =================================
maxclients 10000

# =================================
# Slow Log Settings
# =================================
slowlog-log-slower-than 10000  # 10 milliseconds
slowlog-max-len 128

# =================================
# Advanced Settings
# =================================
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100

# =================================
# Active Rehashing
# =================================
activerehashing yes

# =================================
# Client Output Buffer Limits
# =================================
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =================================
# Client Query Buffer
# =================================
client-query-buffer-limit 1gb

# =================================
# Protocol Buffer
# =================================
proto-max-bulk-len 512mb

# =================================
# Frequency Settings
# =================================
hz 10

# =================================
# Dynamic HZ
# =================================
dynamic-hz yes

# =================================
# AOF Rewrite Settings
# =================================
aof-rewrite-incremental-fsync yes

# =================================
# RDB Settings
# =================================
rdb-save-incremental-fsync yes

# =================================
# LFU Settings (for maxmemory-policy allkeys-lfu)
# =================================
lfu-log-factor 10
lfu-decay-time 1

# =================================
# Lazy Freeing Settings
# =================================
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# =================================
# Threading Settings (Redis 6.0+)
# =================================
# io-threads 4
# io-threads-do-reads yes

# =================================
# ACL Settings (Redis 6.0+)
# =================================
# ACL configuration would go here if using Redis ACLs
# For now, using simple password authentication

# =================================
# Misc Settings
# =================================
supervised no
notify-keyspace-events ""
replica-read-only yes
replica-serve-stale-data yes
replica-priority 100

# =================================
# Replication Settings
# =================================
# These would be configured for master-slave setups
# repl-diskless-sync no
# repl-diskless-sync-delay 5
# repl-ping-replica-period 10
# repl-timeout 60
# repl-disable-tcp-nodelay no
# repl-backlog-size 1mb
# repl-backlog-ttl 3600

# =================================
# Sentinel Settings
# =================================
# These would be configured for Redis Sentinel setups
# Not needed for single-instance setup

# =================================
# TLS Settings
# =================================
# TLS is handled at the application/proxy level
# port 0
# tls-port 6380
# tls-cert-file redis.crt
# tls-key-file redis.key
# tls-ca-cert-file ca.crt